# Fix Bug: Pydantic Settings khÃ´ng parse Ä‘Æ°á»£c `List[str]` tá»« CSV string

## ğŸ› Hiá»‡n tÆ°á»£ng lá»—i

```python
# Config
youtube_channels: List[str] = Field(alias="YOUTUBE_CHANNELS")

# .env file
YOUTUBE_CHANNELS=channel1,channel2,channel3
```

**Káº¿t quáº£:**
```
JSONDecodeError: Expecting value: line 1 column 1 (char 0)
error parsing value for field "youtube_channels"
```

---

## ğŸ” NguyÃªn nhÃ¢n

### Flow gÃ¢y lá»—i:
```
1. pydantic-settings Ä‘á»c env var â†’ "channel1,channel2"
2. Tháº¥y type hint List[str] â†’ "ÄÃ¢y lÃ  JSON array!"
3. Gá»i json.loads("channel1,channel2") â†’ âŒ Lá»–I
4. Validator mode="before" khÃ´ng Ä‘Æ°á»£c gá»i (lá»—i xáº£y ra trÆ°á»›c Ä‘Ã³)
```

### Äiá»ƒm máº¥u chá»‘t:
- **pydantic-settings** tá»± Ä‘á»™ng parse JSON khi gáº·p `List`, `Dict`, etc.
- Parsing xáº£y ra **TRÆ¯á»šC** validator `mode="before"`
- CSV string khÃ´ng pháº£i JSON há»£p lá»‡ â†’ lá»—i ngay

---

## âœ… Giáº£i phÃ¡p: `@computed_field`

### Code má»›i:

```python
from pydantic import Field, computed_field
from pydantic_settings import BaseSettings

class ScrapingConfig(BaseSettings):
    # âœ… LÆ°u raw string (internal field)
    _youtube_channels_raw: str = Field(
        default="",
        alias="YOUTUBE_CHANNELS"
    )
    
    # âœ… Expose parsed list (computed property)
    @computed_field
    @property
    def youtube_channels(self) -> List[str]:
        """Parse CSV string thÃ nh list lÃºc runtime"""
        if not self._youtube_channels_raw.strip():
            return []
        return [
            ch.strip() 
            for ch in self._youtube_channels_raw.split(",") 
            if ch.strip()
        ]
```

### CÃ¡ch dÃ¹ng (khÃ´ng Ä‘á»•i):
```python
config = ScrapingConfig()
for channel in config.youtube_channels:  # âœ… Váº«n lÃ  List[str]
    print(channel)
```

---

## ğŸ¯ Táº¡i sao cÃ¡ch nÃ y work?

| BÆ°á»›c | Äiá»u gÃ¬ xáº£y ra | Káº¿t quáº£ |
|------|----------------|---------|
| 1. pydantic-settings parse | Tháº¥y `_youtube_channels_raw: str` | âœ… LÆ°u string, khÃ´ng parse JSON |
| 2. Access `config.youtube_channels` | Gá»i `@computed_field` property | âœ… Parse CSV â†’ List lÃºc runtime |
| 3. Type checking | IDE tháº¥y return type `List[str]` | âœ… Type safe, autocomplete work |

**CÃ´ng thá»©c:**
```
Storage (str) + Computed Property = Type-safe List
```

---

## ğŸ“ CÃ¡c bÆ°á»›c sá»­a code

### 1. ThÃªm import
```python
from pydantic import EmailStr, Field, field_validator, computed_field
```

### 2. Äá»•i field declaration
```python
# âŒ CÅ©
youtube_channels: List[str] = Field(
    default_factory=list,
    alias="YOUTUBE_CHANNELS"
)

# âœ… Má»›i
_youtube_channels_raw: str = Field(
    default="",
    alias="YOUTUBE_CHANNELS"
)
```

### 3. ThÃªm computed property
```python
@computed_field
@property
def youtube_channels(self) -> List[str]:
    if not self._youtube_channels_raw.strip():
        return []
    return [ch.strip() for ch in self._youtube_channels_raw.split(",") if ch.strip()]
```

### 4. XÃ³a validator cÅ©
```python
# âŒ XÃ³a method nÃ y
@field_validator("youtube_channels", mode="before")
def parse_youtube_channels(cls, v): ...
```

---

## ğŸ†š So sÃ¡nh approaches

| Approach | Parse CSV? | Type safe? | Káº¿t quáº£ |
|----------|-----------|------------|---------|
| `List[str]` + validator | âŒ JSON error | - | **Lá»–I** |
| `str` + validator return List | âœ… | âŒ Type conflict | **Lá»–I** |
| `str` + `@computed_field` | âœ… | âœ… | **âœ… WORK** |

---

## ğŸ’¡ Æ¯u Ä‘iá»ƒm cá»§a `@computed_field`

âœ… **TÃ¡ch biá»‡t storage vs interface**
- Storage: raw string tá»« env
- Interface: parsed list cho code

âœ… **Type safe hoÃ n toÃ n**
- IDE autocomplete
- Type checker hoáº¡t Ä‘á»™ng
- Return type rÃµ rÃ ng

âœ… **Lazy evaluation**
- Chá»‰ parse khi cáº§n dÃ¹ng
- Tiáº¿t kiá»‡m performance

âœ… **Framework-friendly**
- KhÃ´ng fight vá»›i pydantic-settings
- Follow best practices

âœ… **Dá»… extend logic**
```python
@computed_field
@property
def youtube_channels(self) -> List[str]:
    channels = self._youtube_channels_raw.split(",")
    # CÃ³ thá»ƒ thÃªm filter, validation, transformation
    return [ch for ch in channels if ch.startswith("UC")]
```

---

## ğŸ“Œ Nhá»› nhanh

```
Lá»—i: List[str] â†’ pydantic-settings parse JSON â†’ boom!
Fix:  str (storage) + @computed_field (interface) = win!
```

**Pattern:**
1. Internal field: `_raw_data: str`
2. Public property: `@computed_field` parse â†’ `List`
3. User khÃ´ng biáº¿t gÃ¬, váº«n dÃ¹ng nhÆ° cÅ©

---

## ğŸ”§ .env file khÃ´ng Ä‘á»•i

```bash
# Váº«n dÃ¹ng CSV format nhÆ° bÃ¬nh thÆ°á»ng
YOUTUBE_CHANNELS=channel1,channel2,channel3

# Hoáº·c Ä‘á»ƒ trá»‘ng
YOUTUBE_CHANNELS=
```

---

## âš ï¸ LÆ°u Ã½

- `@computed_field` cáº§n Pydantic v2+
- Field internal báº¯t Ä‘áº§u `_` Ä‘á»ƒ trÃ¡nh export
- Property tÃ­nh má»—i láº§n access (náº¿u cáº§n cache, dÃ¹ng `@cached_property`)

---

## ğŸ“ BÃ i há»c

**Khi dÃ¹ng pydantic-settings vá»›i complex types:**
1. Hiá»ƒu parsing order: env source â†’ validation â†’ field
2. `mode="before"` khÃ´ng cá»©u Ä‘Æ°á»£c JSON parsing errors
3. DÃ¹ng simple types (str, int) cho storage
4. DÃ¹ng `@computed_field` cho transformations
5. TÃ¡ch concerns: storage â‰  interface